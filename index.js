// Ingredient portion is for one person
const json = {
    "recipes": {
        "protein_breakfast": {
            "meta": {
                title: "Protein breakfast",
                src: "imgs/protein_breakfast.webp",
            },
            "flocon_avoine": {
                "quantity": 50,
                "measure": "g",
            },
            "yaourt": {
                "quantity": 100,
                "measure": "g",
            },
            "banane": {
                "quantity": 1,
                "measure": null,
            },
            "chocolat_noir": {
                "quantity": 25,
                "measure": "g",
            }
        },
        "beurre_bread_breakfast": {
            "meta": {
                title: "beurre bread breakfast",
                src: "imgs/pain_beurre.webp",
            },
            "pain_de_mie": {
                "quantity": 2,
                "measure": null,
            },
            "beurre": {
                "quantity": 15,
                "measure": "g",
            },
        },
        "skyr_granola_breakfast": {
            "meta": {
                title: "Skyr granola breakfast",
                src: "imgs/skyr_granola_breakfast.webp",
            },
            "skyr": {
                "quantity": 1,
                "measure": null,
            },
            "granola_maison": {
                "quantity": 20,
                "measure": "g",
            },
            "myrtille": {
                "quantity": 20,
                "measure": "g",
            }
        },
            "chicken_teriyaki_jow": {
            "meta": {
                title: "Chicken teriyaki summer bowl from jow",
                src: "imgs/chicken_teriyaki_bowl_jow.jpg",
            },
            "tomate_cerise": {
                "quantity": 120,
                "measure": "g",
            },
            "poulet": {
                "quantity": 1,
                "measure": "slice",
            },
            "sauce_soja": {
                "quantity": 15,
                "measure": "ml",
            },
            "riz": {
                "quantity": 1,
                "measure": "person",
            },
            "graines_de_sesame": {
                "quantity": 5,
                "measure": "g",
            },
            "salade": {
                "quantity": 10,
                "measure": "g",
            },
        },
        "oignon_beef_cooking_with_morgane": {
            "meta": {
                title: "Oignon beef cooking with morgane",
                src: "imgs/oinion_beef_morgane.jpg",
            },
            "boeuf": {
                "quantity": 150,
                "measure": "g",
            },
            "farine": {
                "quantity": 10,
                "measure": "g",
            },
            "sauce_oyster": {
                "quantity": 7,
                "measure": "g",
            },
            "sauce_soja": {
                "quantity": 7,
                "measure": "ml",
            },
            "oignon": {
                "quantity": 125,
                "measure": "g",
            },
        },
        "burger_maison": {
            "meta": {
                title: "Burger Maison by moi meme",
                src: "imgs/burger_maison.jpg",
            },
            "viande_hachee": {
                "quantity": 150,
                "measure": "g",
            },
            "frites": {
                "quantity": 150,
                "measure": "g",
            },
            "pain_burger": {
                "quantity": 1,
                "measure": null,
            },
            "salade": {
                "quantity": 10,
                "measure": "g",
            },
            "tomate": {
                "quantity": 0.25,
                "measure": null,
            },
            "cornichon": {
                "quantity": 3,
                "measure": "g",
            },
            "oignon": {
                "quantity": 0.10,
                "measure": null,
            },
            "mayonnaise": {
                "quantity": 10,
                "measure": "g",
            },
            "sauce_barbecue": {
                "quantity": 10,
                "measure": "g",
            }
        },
        "tonkatsu_pork": {
            "meta": {
                title: "Tonkatsu pork",
                src: "imgs/tonkkatsu_pork.jpg",
            },
            "porc": {
                "quantity": 1,
                "measure": null,
            },
            "farine": {
                "quantity": 30,
                "measure": "g",
            },
            "oeuf": {
                "quantity": 1,
                "measure": null,
            },
            "panko": {
                "quantity": 40,
                "measure": "g",
            },
            "riz": {
                "quantity": 60,
                "measure": "g",
            },
            "broccoli": {
                "quantity": 0.3,
                "measure": null,
            }
        },
        "pasta_arrabiata": {
            "meta": {
                title: "Pasta arrabiata",
                src: "imgs/pasta_arrabiata.webp",
            },
            "pates_mafaldine": {
                "quantity": 80,
                "measure": "g",
            },
            "ail": {
                "quantity": 1,
                "measure": null,
            },
            "tomate": {
                "quantity": 0.5,
                "measure": null,
            },
            "sauce_tomate_concentree": {
                "quantity": 0.5,
                "measure": "small can",
            },
        },
        "sushi": {
            "meta": {
                title: "Sushi maison",
                src: "imgs/sushi_avocado.jpg",
            },
            "riz_sushi": {
                "quantity": 70,
                "measure": "g",
            },
            "avocat": {
                "quantity": 0.5,
                "measure": null,
            },
            "nori_sheet": {
                "quantity": 1.5,
                "measure": null,
            },
            "frozen_salmon": {
                "quantity": 0.5,
                "measure": null,
            },
            "sauce_soja": {
                "quantity": 5,
                "measure": "ml",
            },
            "oignon_frits": {
                "quantity": 5,
                "measure": "g",
            }
        },
        "hot_dog": {
            "meta": {
                title: "Hot dog",
                src: "imgs/hot_dog.webp",
            },
            "hot_dog_bread": {
                "quantity": 2,
                "measure": null,
            },
            "sausage": {
                "quantity": 2,
                "measure": null,
            },
            "ketchup": {
                "quantity": 10,
                "measure": "g",
            },
            "mustard": {
                "quantity": 10,
                "measure": "g",
            },
            "salade": {
                "quantity": 10,
                "measure": "g",
            }
        },
        "lomo_saltado": {
            "meta": {
                title: "Lomo saltado",
                src: "imgs/lomo_saltado.jpg",
            },
            "boeuf": {
                "quantity": 70,
                "measure": "g",
            },
            "oignon": {
                "quantity": 0.25,
                "measure": null,
            },
            "poivre": {
                "quantity": 0.25,
                "measure": null,
            },
            "tomate": {
                "quantity": 0.5,
                "measure": null,
            },
            "sauce_soja": {
                "quantity": 15,
                "measure": "ml",
            },
            "sauce_oyster": {
                "quantity": 10,
                "measure": "g",
            },
            "vinaigre_blanc": {
                "quantity": 5,
                "measure": "ml",
            },
            "riz": {
                "quantity": 75,
                "measure": "g",
            },
            "frites": {
                "quantity": 150,
                "measure": "g",
            }
        },
        // https://jow.fr/en/recipes/chicken-ramen-soup-81ya71eklqb400wj0kih
        "chicken_ramen_jow": {
            "meta": {
                title: "Chicken ramen soup from jow",
                src: "imgs/chicken_ramen_soup_jow.jpg",
            },
            "nouilles": {
                "quantity": 80,
                "measure": "g"
            },
            "ail": {
                "quantity": 0.5,
                "measure": null,
            },
            "poulet": {
                "quantity": 1,
                "measure": null,
            },
            "champignon": {
                "quantity": 50,
                "measure": "g",
            },
            "pate_miso": {
                "quantity": 0.5,
                "measure": "tbsp"
            },
            "bouillon_cube_poulet": {
                "quantity": 0.5,
                "measure": null
            },
            "gingembre": {
                "quantity": 1,
                "measure": null
            },
            "coriandre": {
                "quantity": 0.2,
                "measure": null,
                "optional": true
            }
        },
        "picard_meal": {
            "meta": {
                title: "Picard meal",
                src: "imgs/any_picard.webp",
            },
            "picard_meal": {
                "quantity": 1,
                "measure": null,
            },
        },
        "rice_gyoza_nem_picard": {
            "meta": {
                title: "Rice gyoza nem picard",
                src: "imgs/rice_nem_gyoza_picard.jpeg",
            },
            "riz": {
                "quantity": 70,
                "measure": null,
            },
            "nem_picard": {
                "quantity": 0.5,
                "measure": null,
            },
            "gyoza_picard": {
                "quantity": 0.5,
                "measure": null,
            },
            "broccoli": {
                "quantity": 0.3,
                "measure": null,
            }
        },
        "bananes": {
            "meta": {
                title: "bananes",
                src: "imgs/banane.jpg",
            },
            "banane": {
                "quantity": 1,
                "measure": null,
            }
        },
        "batata_harra_and_meat": {
            "meta": {
                title: "Libanese potatoes (batata harra) and meat",
                src: "imgs/libanese_potatoes.webp",
            },
            "potatoes": {
                "quantity": 3,
                "measure": null,
            },
            "boeuf": {
                "quantity": 0.5,
                "measure": null,
            },
            "coriandre": {
                "quantity": 0.3,
                "measure": null,
            },
            "epice_liban_piquante": {
                "quantity": 1,
                "measure": "tbsp",
            }
        },
        "eggplant_strifry": {
            "meta": {
                title: "Eggplant strifry",
                src: "imgs/eggplant_stirfry.png",
            },
            "aubergine": {
                "quantity": 0.5,
                "measure": null,
            },
            "sucre_brun": {
                "quantity": 1,
                "measure": "tbsp",
            },
            "sauce_soja": {
                "quantity": 15,
                "measure": "ml",
            },
            "vinaigre_de_riz": {
                "quantity": 7,
                "measure": "ml",
            },
            "graine_de_sesame": {
                "quantity": 1.25,
                "measure": "ml",
            },
            "maizena": {
                "quantity": 0.25,
                "measure": "tbsp",
            },
            "huile_olive": {
                "quantity": 3,
                "measure": "tbsp",
            },
            "ail": {
                "quantity": 2,
                "measure": null,
            },
            "gingembre": {
                "quantity": 2,
                "measure": "tbsp",
            },
            "cebette_(oignon_vert_chinois)": {
                "quantity": 1,
                "measure": null,
            },
            "graines_de_sesame": {
                "quantity": 1,
                "measure": "tbsp",
            }
        },
        "pizza_pesto_picard": {
            "meta": {
                title: "Pizza pesto picard",
                src: "imgs/pizza_pesto_picard.webp",
            },
            "pizza_pesto_picard": {
                "quantity": 1,
                "measure": null,
            }
        },
        "smoked_trout_salad": {
            "meta": {
                title: "Smoked salmon salad",
                src: "imgs/smoked_salmon_salad.png",
            },
            "truite": {
                "quantity": 2,
                "measure": null,
            },
            "avocat": {
                "quantity": 0.5,
                "measure": null,
            },
            "salade": {
                "quantity": 10,
                "measure": "g",
            },
            "concombre": {
                "quantity": 0.2,
                "measure": null,
            },
            "vinaigre_balsamique": {
                "quantity": 10,
                "measure": "g",
            },
            "huile_olive": {
                "quantity": 10,
                "measure": "g",
            }
        },
        "meat_and_fries": {
            "meta": {
                title: "Meat and fries",
                src: "imgs/meat_and_fries.png",
            },
            "boeuf": {
                "quantity": 0.5,
                "measure": null,
            },
            "frites": {
                "quantity": 150,
                "measure": "g",
            },
            "oignon": {
                "quantity": 0.3,
                "measure": null,
            },
            "beurre": {
                "quantity": 30,
                "measure": "g",
            }
        },
        "empanadas": {
            "meta": {
                title: "Empanadas",
                src: "imgs/empanadas.webp",
            },
            "pate_feuilletee_herta_bleue": {
                "quantity": 0.5,
                "measure": null,
            },
            "viande_hachee": {
                "quantity": 0.5,
                "measure": null,
            },
            "oignon": {
                "quantity": 0.3,
                "measure": null,
            },
            "oeuf": {
                "quantity": 1,
                "measure": null,
            },
            "poivre": {
                "quantity": 0.3,
                "measure": null,
            },
            "salade": {
                "quantity": 30,
                "measure": "g",
            }
        },
        "eggplant_curry_otto_lenghi": {
            "meta": {
                title: "Eggplant curry otto lenghi",
                src: "imgs/eggplant_curry_otto_lenghi.png",
            },
            "aubergine": {
                "quantity": 0.5,
                "measure": null,
            },
            "yaourt_grec": {
                "quantity": 50,
                "measure": "g",
            },
            "oignon": {
                "quantity": 0.25,
                "measure": null,
            },
            "ail": {
                "quantity": 1,
                "measure": null,
            },
            "coriandre": {
                "quantity": 0.3,
                "measure": null,
            },
        },
        "cod_with_lemon_beurre_jow": {
            "meta": {
                title: "Cod with lemon beurre, rice & green beans",
                src: "imgs/cod_with_lemon_beurre.png",
            },
            "cabillaud": {
                "quantity": 0.5,
                "measure": null,
            },
            "beurre": {
                "quantity": 15,
                "measure": "g",
            },
            "citron_entier": {
                "quantity": 0.25,
                "measure": null,
            },
            "riz": {
                "quantity": 75,
                "measure": "g",
            },
            "haricots_verts": {
                "quantity": 110,
                "measure": "g",
            },
            "persil": {
                "quantity": 0.2,
                "measure": null,
            }
        },
        "picard_breakfast": {
            "meta": {
                title: "Picard breakfast",
                src: "imgs/picard_breakfast.jpg",
            },
            "picard_breakfast_(croissant_-or_pain_chocolat)": {
                "quantity": 1,
                "measure": null,
            }
        },
        "miso_veggie_noodle_bowl_jow": {
            "meta": {
                title: "Miso veggie noodle bowl from jow",
                src: "imgs/miso_veggie_noodle_bowl_jow.png",
            },
            "nouilles": {
                "quantity": 100,
                "measure": "g",
            },
            "pak_choi": {
                "quantity": 150,
                "measure": "g",
            },
            "champignon_(shiitake)": {
                "quantity": 150,
                "measure": "g",
            },
            "pate_miso": {
                "quantity": 1,
                "measure": "tbsp",
            },
            "sauce_soja": {
                "quantity": 0.5,
                "measure": "ml",
            },
            "huile_chili": {
                "quantity": 0.5,
                "measure": "tbsp",
            }
        }
    },
};

// ========== UTILS========= =================================================
function displayResults (listElem) {
    result.innerHTML = '';
    result.appendChild(listElem);
}

// ========== LOCAL STORAGE =================================================
const STORAGE_KEY = 'formData';
function saveFormDataInLocalStorage (formData) {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(formData));
}

function eraseFormDataInLocalStorage () {
    localStorage.removeItem(STORAGE_KEY);
}

// ========== CREATE FRONT =================================================

const main = document.querySelector('#recipes');
const main_content = main.querySelector('#main_content');
const result = document.querySelector('#result');
const reset = document.querySelector('#reset');

function doesFormDataExistInLocalStorage () {
    return localStorage.hasOwnProperty(STORAGE_KEY) && null !== localStorage.getItem(STORAGE_KEY);
}

if (doesFormDataExistInLocalStorage()) {
    const formData = JSON.parse(localStorage.getItem(STORAGE_KEY));
    displaySubmit(formData);
}

reset.onclick = function () {
    eraseFormDataInLocalStorage();
    result.innerHTML = '';
}

function getQuantitySelectElem() {
    const select = document.createElement('select');

    for (let i = 0; i < 15; i++) {
        const newOption = document.createElement('option');
        newOption.value = i;
        newOption.innerText = i;
        select.appendChild(newOption);
    }

    return select;
}

// TODO RETRIEVE INFO FROM JSON FILE AND NOT FROM CONSTANT
for (const recipeName in json.recipes) {
    const newLabel = document.createElement('label');
    // newLabel.innerText = recipeName;
    newLabel.classList.add('label_style');
    newLabel.for = recipeName;
    const select = getQuantitySelectElem();
    select.name = recipeName;

    // add img if exists and add title
    const meta = json.recipes[recipeName].meta;
    if (meta) {
        const img = document.createElement('img');
        img.src = meta.src;
        img.alt = recipeName;
        img.title = recipeName;
        img.classList.add('image_style');
        newLabel.appendChild(img);
    }

    // add select
    const selectContainer = document.createElement('div');
    selectContainer.classList.add('select_container');
    const minusButton = document.createElement('button');
    minusButton.innerText = '-';
    minusButton.onclick = function () {
        if (0 < select.value) {
            select.value--;
        }
    }
    selectContainer.appendChild(minusButton);
    selectContainer.appendChild(select);
    const plusButton = document.createElement('button');
    plusButton.innerText = '+';
    plusButton.onclick = function () {
        select.value++;
    }
    selectContainer.appendChild(plusButton);
    newLabel.appendChild(selectContainer);

    // append to main_content
    main_content.appendChild(newLabel);
    // main_content.appendChild(document.createElement('hr'));
}

function getAllRecipeNames () {
    return Object.keys(json.recipes);
}

main.onsubmit = function (e) {
    // ========== RETRIEVE INFO FROM FORM ==========================================
    e.preventDefault();
    const formDataTest = {"recipes": {}};
    for (const recipeName of getAllRecipeNames()) {
        formDataTest.recipes[recipeName] = parseInt(e.target[recipeName].value);
    }
    saveFormDataInLocalStorage(formDataTest);
    displaySubmit(formDataTest);
}

function displaySubmit (formDataTest) {
    // ========== CALCULATE ========================================================
    // test
    // const formDataTest = {
    //     "recipes": {
    //         "lomo": 1,
    //         "nasi_goreng": 4,
    //         "protein_breakfast": 5,
    //         "protein_meal": 5,
    //         "protein_shake": 5,
    //     }
    // };

    const list = {};

    for (const recipeName in formDataTest.recipes) {
        const quantityAsked = formDataTest.recipes[recipeName];

        if (0 === quantityAsked) {
            continue;
        }

        const recipeInfo = json.recipes[recipeName];

        for (const ingredientName in recipeInfo) {
            if ('meta' === ingredientName) {
                continue;
            }
            const ingredientInfo = recipeInfo[ingredientName];

            if (false === list.hasOwnProperty(ingredientName)) {
                list[ingredientName] = {};
                list[ingredientName].quantity = ingredientInfo.quantity * quantityAsked;
                list[ingredientName].measure = ingredientInfo.measure; // would be simpler if I could research the object and find what the measure is
            } else {
                list[ingredientName].quantity += (ingredientInfo.quantity * quantityAsked);
            }
        }
    }

    // ========== SHOW PARSED LIST ========================================================
    const listElem = document.createElement('ul');
    for (const ingredientName in list) {
        const itemElem = document.createElement('li');

        // parse ingredient name
        let ingNameParsed = ingredientName.replace('_', ' '); // TODO uppercase first letter
        itemElem.innerText = `${ingNameParsed} : ${list[ingredientName].quantity} ${list[ingredientName].measure ?? ''}`;
        listElem.appendChild(itemElem);
    }

    displayResults(listElem);
}
